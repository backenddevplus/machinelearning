################################################################################
# ML.NET's official, signed build 
################################################################################

resources:
  containers:
  - container: LinuxContainer
    image: microsoft/dotnet-buildtools-prereqs:centos-7-b46d863-20180719033416

phases:

################################################################################
- phase: Windows_x64
################################################################################
  variables:
    BuildConfig: Release
    OfficialBuildId: $(BUILD.BUILDNUMBER)
    DOTNET_CLI_TELEMETRY_OPTOUT: 1
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
    DOTNET_MULTILEVEL_LOOKUP: 0
    _SignType: real
    _UseEsrpSigning: true
    _TeamName: DotNetCore
  queue:
    name: DotNetCore-Build
    demands: 
      - agent.os -equals Windows_NT
  steps:

  # Build both native and managed assets. 
  - script: ./build.cmd -$(BuildConfig)
    displayName: Build
  
  # Terminate all dotnet build processes.
  - script: $(Build.SourcesDirectory)/Tools/dotnetcli/dotnet.exe build-server shutdown
    displayName: Dotnet Server Shutdown

################################################################################
- phase: Package
################################################################################
  dependsOn:
  - Windows_x64
  variables:
    BuildConfig: Release
    OfficialBuildId: $(BUILD.BUILDNUMBER)
    DOTNET_CLI_TELEMETRY_OPTOUT: 1
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
    DOTNET_MULTILEVEL_LOOKUP: 0
    _TeamName: DotNetCore
    _NuGetFeedUrl: https://dotnet.myget.org/F/dotnet-core/api/v2/package
    _SymwebSymbolServerPath: https://microsoft.artifacts.visualstudio.com/DefaultCollection
    _MsdlSymbolServerPath: https://microsoftpublicsymbols.artifacts.visualstudio.com/DefaultCollection
  queue:
    name: DotNetCore-Build
    demands: 
      - agent.os -equals Windows_NT
  steps:
  
  - script: ./build.cmd -buildPackages
    displayName: Create Packages

  - task: NuGetCommand@2 
    displayName: Publish Packages to VSTS Feed 
    inputs:
      command: push 
      packagesToPush: $(Build.SourcesDirectory)/bin/packages/**/*.nupkg
      nuGetFeedType: internal 
      feedPublish: MachineLearning
    
  # Terminate all dotnet build processes.
  - script: $(Build.SourcesDirectory)/Tools/dotnetcli/dotnet.exe build-server shutdown
    displayName: Dotnet Server Shutdown
